



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Blog articles about Office 365 / SharePoint / Azure">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../images/puzzle.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.2">
    
    
      
        <title>Authenticate to SharePoint Online through an Azure Function using PnP Framework - MichaÃ«l Maillot</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:300,400,400i,700%7C&display=fallback">
        <style>body,input{font-family:"Poppins","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="black" data-md-color-accent="light-blue">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#authenticate-to-sharepoint-online-through-an-azure-function-using-pnp-framework" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="MichaÃ«l Maillot" aria-label="MichaÃ«l Maillot" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="../../images/puzzle.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              MichaÃ«l Maillot
            </span>
            <span class="md-header-nav__topic">
              
                Authenticate to SharePoint Online through an Azure Function using PnP Framework
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="MichaÃ«l Maillot" class="md-nav__button md-logo">
      
        <img alt="logo" src="../../images/puzzle.png" width="48" height="48">
      
    </a>
    MichaÃ«l Maillot
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#about-azure-functions-v1" class="md-nav__link">
    About Azure Functions v1
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#init-azure-function-v3" class="md-nav__link">
    Init Azure Function v3
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-nuget-packages" class="md-nav__link">
    Get Nuget Packages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-connection-to-sharepoint" class="md-nav__link">
    Setup connection to SharePoint
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#try-it-locally" class="md-nav__link">
    Try it locally
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-connection-with-a-certificate-optional" class="md-nav__link">
    Setup connection with a certificate (optional)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thats-it" class="md-nav__link">
    That's it
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="authenticate-to-sharepoint-online-through-an-azure-function-using-pnp-framework">Authenticate to SharePoint Online through an Azure Function using PnP Framework</h1>
<p>As you know (or maybe not?), the PnP Framework (v1.0.0) is now GA! ðŸŽ‰</p>
<p>For those who are new here, it's a framework developed by the community (Microsoft employees, MVPs and other passionate developers), successor of the PnP Sites Core library and .NET Standard 2.0 compatible (.NET Framework 5 and .NET Core).</p>
<p>As the PnP Sites Core is no longer maintained, the PnP Framework is the new library to use for your Microsoft 365 Developments! This library will extend the SharePoint CSOM library by adding useful features such as simplified authentication flows (including token management), extensions methods to objects, utilities and more!</p>
<p>One important thing to know is that this framework is a transitional one, while the real successor will be the PnP Core SDK (on which PnP Framework and the new PnP PowerShell depends) but is still in beta.</p>
<p>More info <a href="https://github.com/pnp/pnpframework" target="_blank">here</a> and <a href="https://github.com/pnp/pnpcore#whats-the-relationship-with-the-existing-pnp-sites-core--pnp-framework-libraries" target="_blank">here</a>.</p>
<p>Among the major features of the PnP Framework, one is the authentication workflow used inside, which is now based on MSAL SDK for .NET! This is a great improvment, which involves some small changes regarding the code that will manage the authentication. Let's see with a short example!</p>
<h2 id="prerequisites">Prerequisites</h2>
<ol>
<li>An Office 365 (Dev) Tenant or a Partner Demo Tenant</li>
<li>Visual Studio (2017 or later) including the Azure Development workload (<a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local?tabs=windows%2Ccsharp%2Cbash" target="_blank">Azure Function Core (CLI) Tools</a>)</li>
<li>(<em>optional</em>) An Azure subscription and the following Azure AD role at least<ul>
<li>Application Administrator</li>
</ul>
</li>
</ol>
<h2 id="about-azure-functions-v1">About Azure Functions v1</h2>
<p>For those who are familiar with Azure Functions v1 and SharePoint CSOM with latest version of PnP Sites Core library, you're probably aware of a compatibility issue regarding the <strong>Newtonsoft.Json</strong> library, which uses the 9.0.1 version in the <strong>Microsoft.NET.Sdk.Functions</strong> (v1.0.38) library, and a newer version in the PnP Sites Core library (issue referenced <a href="https://github.com/pnp/PnP-Sites-Core/issues/2552" target="_blank">here</a>).</p>
<p>Great news: the PnP Framework works perfectly with Azure Functions v3 (using <strong>Microsoft.NET.Sdk.Functions</strong> v3.0.11), let's check it out!</p>
<h2 id="init-azure-function-v3">Init Azure Function v3</h2>
<p>You can follow <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-your-first-function-visual-studio" target="_blank">this quick start</a> to init a project.</p>
<p>(Follow the steps until the <em>Testing functions</em> part, the Azure part will follow later as an option)</p>
<h3 id="get-nuget-packages">Get Nuget Packages</h3>
<p>Below the Nuget packages required to test the architecture:</p>
<ul>
<li><a href="https://www.nuget.org/packages/Microsoft.SharePointOnline.CSOM" target="_blank">Microsoft.SharePointOnline.CSOM</a> (to work with SharePoint Site)</li>
<li><a href="https://www.nuget.org/packages/PnP.Framework" target="_blank">PnP.Framework</a> (to easily authenticate to SharePoint site)</li>
<li>(<em>optional</em>) <a href="https://www.nuget.org/packages/Azure.Identity/" target="_blank">Azure.Identy</a> (for the authentication to the KeyVault)</li>
<li>(<em>optional</em>) <a href="https://www.nuget.org/packages/Azure.Security.KeyVault.Secrets" target="_blank">Azure.Security.KeyVault.Secrets</a> (to get the certificate)</li>
</ul>
<h3 id="setup-connection-to-sharepoint">Setup connection to SharePoint</h3>
<p>Below the code sample to setup a connection to SharePoint using Client Credential Flow</p>
<div class="superfences-tabs">
<input name="__tabs_1" type="radio" id="__tab_1_0" checked="checked" />
<label for="__tab_1_0">HttpExample.cs</label>
<div class="superfences-content"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="na">[FunctionName(&quot;HttpExample&quot;)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="n">Run</span><span class="p">(</span>
<span class="na">    [HttpTrigger(AuthorizationLevel.Function, &quot;get&quot;, &quot;post&quot;, Route = null)]</span> <span class="n">HttpRequest</span> <span class="n">req</span><span class="p">,</span>
    <span class="n">ILogger</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Web</span> <span class="n">currentWeb</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">userLogin</span> <span class="p">=</span> <span class="s">&quot;AdeleV@contoso.onmicrosoft.com&quot;</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">userPassword</span> <span class="p">=</span> <span class="s">&quot;Pass@w0rd!&quot;</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">sharePointUrl</span> <span class="p">=</span> <span class="s">&quot;https://contoso.sharepoint.com&quot;</span><span class="p">;</span>

    <span class="kt">var</span> <span class="n">securePassword</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SecureString</span><span class="p">();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">char</span> <span class="n">c</span> <span class="k">in</span> <span class="n">userPassword</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">securePassword</span><span class="p">.</span><span class="n">AppendChar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">AuthenticationManager</span> <span class="n">auth</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AuthenticationManager</span><span class="p">(</span><span class="n">userLogin</span><span class="p">,</span> <span class="n">securePassword</span><span class="p">);</span>

    <span class="k">using</span> <span class="p">(</span><span class="n">ClientContext</span> <span class="n">ctx</span> <span class="p">=</span> <span class="k">await</span> <span class="n">auth</span><span class="p">.</span><span class="n">GetContextAsync</span><span class="p">(</span><span class="n">sharePointUrl</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">currentWeb</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Web</span><span class="p">;</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="n">currentWeb</span><span class="p">);</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">ExecuteQueryRetryAsync</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">log</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="err">$</span><span class="s">&quot;Web&#39;s title : {currentWeb.Title}&quot;</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nf">OkObjectResult</span><span class="p">(</span><span class="err">$</span><span class="s">&quot;Web&#39;s title : {currentWeb.Title}&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This authentication method is available through the PnP Framework, but not by design with CSOM for .NET Standard. More info <a href="https://docs.microsoft.com/en-us/sharepoint/dev/sp-add-ins/using-csom-for-dotnet-standard#using-modern-authentication-with-csom-for-net-standard" target="_blank">here</a></p>
</div>
<h3 id="try-it-locally">Try it locally</h3>
<p>Once you've got everything ready, run your function locally! Go to your browser and type <a href="http://localhost:5800/api/HttpExample" target="_blank">http://localhost:5800/api/HttpExample</a></p>
<p>You should see something like this:</p>
<p><em>From the Azure Functions Core Tools</em></p>
<p><img alt="img" src="../../images/articles/20210125/function-app-core-sp-local-console.png" /></p>
<p><em>From the browser</em></p>
<p><img alt="img" src="../../images/articles/20210125/function-app-core-sp-local-web.png" /></p>
<h3 id="setup-connection-with-a-certificate-optional">Setup connection with a certificate (optional)</h3>
<p>Now let's say you want to execute your Function App in an Azure AD (AAD) Application context. The idea is to use a certificate stored in an Azure Key Vault.</p>
<p>For the AAD Application registration, the creation of the Key Vault, the setup of managed identity and the configuration of SharePoint API Permissions, I'll redirect you to my previous article <a href="../20201119-connect-to-sharepoint-apppermission-certificate-keyvault/" target="_blank">here</a>.</p>
<p>Below the complete script to authenticate through AAD</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="na">[FunctionName(&quot;HttpExample&quot;)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="n">Run</span><span class="p">(</span>
<span class="na">    [HttpTrigger(AuthorizationLevel.Function, &quot;get&quot;, &quot;post&quot;, Route = null)]</span> <span class="n">HttpRequest</span> <span class="n">req</span><span class="p">,</span>
    <span class="n">ILogger</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Web</span> <span class="n">currentWeb</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">aadApplicationId</span> <span class="p">=</span> <span class="s">&quot;SHAREPOINT_AAD_APPLICATION_APP_ID&quot;</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">tenantName</span> <span class="p">=</span> <span class="s">&quot;contoso&quot;</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">sharePointUrl</span> <span class="p">=</span> <span class="err">$</span><span class="s">&quot;https://{tenantName}.sharepoint.com/&quot;</span><span class="p">;</span>

    <span class="n">AuthenticationManager</span> <span class="n">auth</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AuthenticationManager</span><span class="p">(</span><span class="n">aadApplicationId</span><span class="p">,</span> <span class="n">GetCertificate</span><span class="p">(),</span> <span class="err">$</span><span class="s">&quot;{tenantName}.onmicrosoft.com&quot;</span><span class="p">);</span>

    <span class="k">using</span> <span class="p">(</span><span class="n">ClientContext</span> <span class="n">ctx</span> <span class="p">=</span> <span class="k">await</span> <span class="n">auth</span><span class="p">.</span><span class="n">GetContextAsync</span><span class="p">(</span><span class="n">sharePointUrl</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">currentWeb</span> <span class="p">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Web</span><span class="p">;</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="n">currentWeb</span><span class="p">);</span>
        <span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">ExecuteQueryRetryAsync</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">log</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="err">$</span><span class="s">&quot;Web&#39;s title : {currentWeb.Title}&quot;</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nf">OkObjectResult</span><span class="p">(</span><span class="err">$</span><span class="s">&quot;Web&#39;s title : {currentWeb.Title}&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="n">X509Certificate2</span> <span class="nf">GetCertificate</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">secretName</span> <span class="p">=</span> <span class="s">&quot;MyCert&quot;</span><span class="p">;</span> <span class="c1">// Name of the certificate</span>
    <span class="n">Uri</span> <span class="n">keyVaultUri</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="err">$</span><span class="s">&quot;https://kvwecommon.vault.azure.net/&quot;</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SecretClient</span><span class="p">(</span><span class="n">keyVaultUri</span><span class="p">,</span> <span class="k">new</span> <span class="n">DefaultAzureCredential</span><span class="p">());</span>
    <span class="n">KeyVaultSecret</span> <span class="n">secret</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">GetSecret</span><span class="p">(</span><span class="n">secretName</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nf">X509Certificate2</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="n">FromBase64String</span><span class="p">(</span><span class="n">secret</span><span class="p">.</span><span class="n">Value</span><span class="p">),</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">,</span> <span class="n">X509KeyStorageFlags</span><span class="p">.</span><span class="n">MachineKeySet</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>

<h3 id="thats-it">That's it</h3>
<p>As you can see, the main object to work with during authentication is the <code>AutenticationManager</code> object, which will lead you to manage authentication flows, such as client credential, device code or certificate. It's this object that will now handle login info (except for legacy SharePoint AppOnly authentication which uses Azure ACS).</p>
<p>Happy coding!</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://twitter.com/michaelmaillot" target="_blank" rel="noopener" title="twitter" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="http://github.com/michaelmaillot" target="_blank" rel="noopener" title="github" class="md-footer-social__link fa fa-github"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>